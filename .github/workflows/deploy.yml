name: Deploy API to Server

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy API to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ğŸ”„ Starting API deployment..."
          
          # Ir al directorio del proyecto
          cd ~/git/api-projects/proyecto-api
          
          # Hacer backup del estado actual
          echo "ğŸ“¦ Creating backup..."
          git stash push -m "pre-deploy-backup-$(date +%Y%m%d_%H%M%S)" || true
          
          # Actualizar cÃ³digo
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          # Parar contenedores actuales
          echo "ğŸ›‘ Stopping current API containers..."
          docker-compose down || true
          
          # Construir y iniciar nuevos contenedores
          echo "ğŸ—ï¸ Building and starting API..."
          docker-compose up -d --build
          
          # Esperar a que el servicio estÃ© listo
          echo "â³ Waiting for API to be ready..."
          sleep 10
          
          # Verificar que todo estÃ¡ funcionando
          echo "âœ… Verifying API deployment..."
          docker-compose ps
          
          # Test bÃ¡sico de conectividad (opcional)
          curl -f http://localhost:3001/actuator/health || echo "âš ï¸ Health check failed, but container is running"
          
          # Limpiar imÃ¡genes no utilizadas
          echo "ğŸ§¹ Cleaning up..."
          docker system prune -f
          
          echo "ğŸ‰ API deployment completed successfully!"

    - name: ğŸ“§ Notify success
      if: success()
      run: |
        echo "âœ… API Deployment successful!"
        echo "ğŸ“ Server: ${{ secrets.SERVER_HOST }}:3001"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"

    - name: âŒ Notify failure
      if: failure()
      run: |
        echo "âŒ API Deployment failed!"
        echo "Check logs above for details"
